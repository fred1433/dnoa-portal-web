name: Sync to Azure DevOps

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout GitHub repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Configure Azure DevOps Authentication
      env:
        AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
      run: |
        # Configure git user
        git config --global user.email "fredric.de@dentistryautomation.com"
        git config --global user.name "FrÃ©dÃ©ric de Lavenne de Choulot"
        
        # Configure Basic Auth for Azure DevOps (username MUST NOT be empty)
        USERNAME="git"  # Azure DevOps requires a non-empty username
        B64=$(printf '%s' "$USERNAME:${AZURE_DEVOPS_PAT}" | base64)
        git config --global http.https://dev.azure.com/.extraheader "Authorization: Basic $B64"
        git config --global credential.useHttpPath true
        
    - name: Clone and Update Azure Repo
      run: |
        # Create temp directory
        mkdir -p temp-azure
        cd temp-azure
        
        # Clone Azure repo (auth is handled by extraheader config)
        git clone https://dev.azure.com/Simplifi-dentistry/AI-Powered-Scrapping/_git/AI-Powered-Scrapping .
        
        # Create or update scrapers/dental-portal directory
        mkdir -p scrapers/dental-portal
        
        # Copy all files from GitHub repo
        cp -r ../* scrapers/dental-portal/ 2>/dev/null || true
        cp -r ../.[^.]* scrapers/dental-portal/ 2>/dev/null || true
        
        # Remove sensitive files we don't want in Azure
        rm -rf scrapers/dental-portal/.env
        rm -rf scrapers/dental-portal/.git
        rm -rf scrapers/dental-portal/.github
        rm -rf scrapers/dental-portal/*-session/storageState.json
        
        # Copy original README to Azure folder
        cp README.md scrapers/dental-portal/ 2>/dev/null || true
        
        # Add and commit changes
        git add .
        git status
        
        # Commit with descriptive message
        COMMIT_MSG="ðŸ”„ Sync from GitHub: $(git --git-dir=../.git log -1 --pretty=%B | head -1)"
        git commit -m "$COMMIT_MSG" || echo "No changes to commit"
        
        # Push to Azure DevOps
        git push origin main || \
        git push origin master || \
        git push origin dev