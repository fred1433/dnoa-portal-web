name: Sync to Azure DevOps

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout GitHub repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Push to Azure DevOps
      env:
        AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
      run: |
        # Configure git
        git config --global user.email "fredric.de@dentistryautomation.com"
        git config --global user.name "Frédéric de Lavenne de Choulot"
        
        # Add Azure DevOps as remote
        git remote add azure https://${AZURE_DEVOPS_PAT}@dev.azure.com/Simplifi-dentistry/AI-Powered-Scrapping/_git/AI-Powered-Scrapping
        
        # Create scrapers/dental-portal directory structure if needed
        mkdir -p temp-azure
        cd temp-azure
        
        # Clone Azure repo
        git clone https://${AZURE_DEVOPS_PAT}@dev.azure.com/Simplifi-dentistry/AI-Powered-Scrapping/_git/AI-Powered-Scrapping .
        
        # Create or update scrapers/dental-portal directory
        mkdir -p scrapers/dental-portal
        
        # Copy all files from GitHub repo
        cp -r ../* scrapers/dental-portal/ 2>/dev/null || true
        cp -r ../.[^.]* scrapers/dental-portal/ 2>/dev/null || true
        
        # Remove sensitive files we don't want in Azure
        rm -rf scrapers/dental-portal/.env
        rm -rf scrapers/dental-portal/.git
        rm -rf scrapers/dental-portal/.github
        rm -rf scrapers/dental-portal/*-session/storageState.json
        
        # Update README with latest status
        cat > scrapers/dental-portal/README.md << 'ENDREADME'
# Dental Portal Extractor

## 🎯 Overview
Complete dental insurance portal automation system with 5 portals fully integrated.

## 🚀 Live Demo
- **Production**: https://dental-portal-extractor.onrender.com/?key=demo2024secure
- **Monitor**: https://dental-portal-extractor.onrender.com/monitor?key=demo2024secure

## ✅ Completed Portals (5/42)

| Portal | Status | Features | CDT Codes |
|--------|--------|----------|-----------|
| DNOA | ✅ Complete | API Direct | ✅ Yes |
| MetLife | ✅ Complete | Playwright + Session | ✅ Yes |
| DentaQuest | ✅ Complete | API Direct | ✅ Yes |
| Cigna | ✅ Complete | Playwright + OTP | ✅ Yes (10 codes) |
| Aetna | ✅ Complete | Session Persistence | ✅ Yes |

## 📊 Features
- ✅ Patient eligibility verification
- ✅ Benefits and coverage details
- ✅ CDT procedure codes extraction
- ✅ Deductibles and maximums tracking
- ✅ Claims history retrieval
- ✅ Session persistence (30+ days)
- ✅ Real-time monitoring dashboard
- ✅ Parallel portal processing

## 🛠️ Architecture
- **Runtime**: Node.js v18+
- **Automation**: Playwright
- **API**: Express + SSE
- **Sessions**: Persistent storage
- **Deployment**: Render (Production)

## 📈 Performance
- Average extraction: 15-30 seconds
- Success rate: 95%+
- Session persistence: 30-90 days
- Parallel processing: All portals simultaneously

## 👥 Team
- **Lead Developer**: Frédéric de Lavenne de Choulot
- **Project Manager**: Donglin Liang

## 📅 Last Updated
$(date '+%B %d, %Y')
ENDREADME
        
        # Add and commit changes
        git add .
        git status
        
        # Commit with descriptive message
        COMMIT_MSG="🔄 Sync from GitHub: $(git --git-dir=../.git log -1 --pretty=%B | head -1)"
        git commit -m "$COMMIT_MSG" || echo "No changes to commit"
        
        # Push to Azure DevOps
        git push origin main || git push origin master || git push origin dev